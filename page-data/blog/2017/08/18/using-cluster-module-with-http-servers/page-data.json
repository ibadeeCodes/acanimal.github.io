{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2017/08/18/using-cluster-module-with-http-servers/","webpackCompilationHash":"8f6cb71590af4882ab75","result":{"data":{"markdownRemark":{"html":"<p>The <a href=\"https://nodejs.org/api/cluster.html\">cluster</a> module allow us improve performance of our application in multicore CPU systems. This is specially important no matter if working on an APIs or an, i.e. ExpressJS based, web servers, what we desire is to take advantage of all the CPUs on each machine our NodeJS application is running.</p>\n<p>The cluster module allow us to load balance the incoming request among a set of worker processes and, because of this, improving the throughput of our application.</p>\n<p>In the previous post <a href=\"%7B%7B%20site.baseurl%20%7D%7D%7B%25%20post_url%202017-08-12-understanding-the-nodejs-cluster-module%20%25%7D\">Understanding the NodeJS cluster module</a> I introduced the cluster module and show some basic usages of it to create worker processes and comunicate them with the master process. In this post we are going to see how to use the cluster module when creating HTTP servers, both using plain <a href=\"https://nodejs.org/api/http.html\">HTTP</a> module and with ExpressJS.</p>\n<!--more-->\n<hr>\n<p>More on this series:</p>\n<ol>\n<li><a href=\"/2017/08/12/understanding-the-nodejs-cluster-module\">Understanding the NodeJS cluster module</a></li>\n<li><strong>Using cluster module with HTTP servers</strong></li>\n<li><a href=\"/2017/08/20/using-pm2-to-manage-cluster\">Using PM2 to manage a NodeJS cluster</a></li>\n<li><a href=\"/2017/08/27/graceful-shutdown-node-processes\">Graceful shutdown NodeJS HTTP server when using PM2</a></li>\n</ol>\n<h2>Using cluster module with HTTP servers</h2>\n<p>Lets go to see how we can create a really basic HTTP server that takes profit of the cluster module.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> cluster <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cluster'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> numCPUs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'os'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">cpus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cluster<span class=\"token punctuation\">.</span>isMaster<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">masterProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">childProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">masterProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Master </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>pid<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> is running`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> numCPUs<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Forking process number </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">...`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cluster<span class=\"token punctuation\">.</span><span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">childProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`Worker </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>pid<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> started...`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hello World'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>We have diveded the code in two parts, the one corresponding to the master process and the one where we initialize the worker processes. This way the <code class=\"language-text\">masterProcess</code> function forks a worker process per CPU code. On the other hand the <code class=\"language-text\">childProcess</code> simply creates an HTTP server listenen on port 3000 and returning a nice <code class=\"language-text\">Hello World</code> text string with a 200 status code.</p>\n<p>If you run the code the output must show something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ node app.js\n\nMaster 1859 is running\nForking process number 0<span class=\"token punctuation\">..</span>.\nForking process number 1<span class=\"token punctuation\">..</span>.\nForking process number 2<span class=\"token punctuation\">..</span>.\nForking process number 3<span class=\"token punctuation\">..</span>.\nWorker 1860 started<span class=\"token punctuation\">..</span>.\nWorker 1862 started<span class=\"token punctuation\">..</span>.\nWorker 1863 started<span class=\"token punctuation\">..</span>.\nWorker 1861 started<span class=\"token punctuation\">..</span>.</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Basically our initial process (the master) is spawing a new worker process per CPU that runs an HTTP server that handle requests. As you can see this can improve a lot your server performance because it is not the same having one processing attending one million of requests than having four processes attending one millun requests.</p>\n<h2>How cluster module works with network connections ?</h2>\n<p>The previous example is simple but hides something tricky, some <em>magic</em> NodeJS make to simplify our live as developer.</p>\n<p>In any OS a process can use a port to communicate with other systems and, that means, the given port can only be used by that process. So, the question is, <strong>how can the forked worker processes use the same port?</strong></p>\n<p>The answer, the simplified answer, is the master process is the one who listens in the given port and load balances the requests among all the child/worker processes. From the offical documentation:</p>\n<blockquote>\n<p>The worker processes are spawned using the child_process.fork() method, so that they can communicate with the parent via IPC and pass server handles back and forth.</p>\n<p>The cluster module supports two methods of distributing incoming connections.</p>\n<ul>\n<li>The first one (and the default one on all platforms except Windows), is the round-robin approach, where the master process listens on a port, accepts new connections and distributes them across the workers in a round-robin fashion, with some built-in smarts to avoid overloading a worker process.</li>\n<li>The second approach is where the master process creates the listen socket and sends it to interested workers. The workers then accept incoming connections directly.</li>\n</ul>\n<p><strong>As long as there are some workers still alive, the server will continue to accept connections. If no workers are alive, existing connections will be dropped and new connections will be refused.</strong></p>\n</blockquote>\n<h2>Other alternatives to cluster module load balancing</h2>\n<p>Cluster module allow the master process to receive request and load balance it among all the worker processes. This is a way to improve performance but it is not the only one.</p>\n<p>In the post <a href=\"https://medium.com/@fermads/node-js-process-load-balancing-comparing-cluster-iptables-and-nginx-6746aaf38272\">Node.js process load balance performance: comparing cluster module, iptables and Nginx</a> you can find a performance comparison among: node cluster module, iptables and nginx reverse proxy.</p>\n<h2>Conclusions</h2>\n<p>Nowadays performance is mandatory on any web applications, we need to support high throughput and serve data fast.</p>\n<p>The cluster module is one possible solution, it allows us to have one master process and create a worker processes for each core, so that they run an HTTP server. The cluster module offers two great features:</p>\n<ul>\n<li>simplifies communication among master and workers, by creating an IPC channel and allowing send messages with <code class=\"language-text\">process.send()</code>,</li>\n<li>allow worker processes share the same port. This is done making the master process the one which receives requests and multiplexe them among workers.</li>\n</ul>","excerpt":"The cluster module allow us improve performance of our application in multicore CPU systems. This is specially important no matter if working on an APIs or an, i.e. ExpressJS based, web servers, what we desire is to take advantage of all the CPUs on each machine our NodeJS application is running. The cluster module allow us to load balance the incoming request among a set of worker processes and, because of this, improving the throughput of our application. In the previous post Understanding the NodeJS cluster module I introduced the cluster module and show some basic usages of it to create worker processes and comunicate them with the master process. In this post we are going to see how to use the cluster module when creating HTTP servers, both using plain HTTP module and with ExpressJS.","frontmatter":{"date":"18 August, 2017","title":"Using cluster module with HTTP servers"},"fields":{"slug":"/blog/2017/08/18/using-cluster-module-with-http-servers/","readingTime":{"text":"5 min read"}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/2017/08/18/using-cluster-module-with-http-servers/"}}}