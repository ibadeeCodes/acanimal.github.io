{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2015/03/30/the-mystery-of-no-flash-session-variables-in-express-passport-auth","webpackCompilationHash":"642efac6ed852a3b544d","result":{"data":{"markdownRemark":{"html":"<p>Recently I started an application using <a href=\"https://nodejs.org/\">NodeJS</a> with <a href=\"http://expressjs.com/\">ExpressJS</a> framework and decided to use <a href=\"http://passportjs.org/\">passport</a> for authenticate the users. As many other times I wanted to use flash messages so, when user authentication fails, the application shows a message informing about bad credentials. Nothing new on the horizon until.... OMG !!! I can't see the flash messages !!!</p>\n<blockquote>\n<p>Disclaimer: This is a really stupid history with me as starring.</p>\n</blockquote>\n<p>I like to learn from my errors and because of this I decide to write this post both as a punishment and to ensure I don't forget it again.</p>\n<h3>The crime scene</h3>\n<p>I was working implementing a sign up process, where the user writes its credentials and system creates as a new user or returns an error message like \"Sorry, but a username with that email exists\" or similar.</p>\n<p>Before introduce any code, the flow is as follows:</p>\n<ul>\n<li>User access the <code class=\"language-text\">/signup</code> page via GET method.</li>\n<li>\n<p>Data is sent to <code class=\"language-text\">/signup</code> resource via POST method, which is responsible to:</p>\n<ul>\n<li>Check if data is fine, create a new user and redirected to the <code class=\"language-text\">/profile</code> page.</li>\n<li>If a user with the same email exists we redirect again to the <code class=\"language-text\">/signup</code> page (that is, using the GET method) with a flash message related to bad credentials.</li>\n</ul>\n</li>\n</ul>\n<blockquote>\n<p>Note: A flash message is a variable stored within a session that is only available once, for the next request. That is if we put a flash variable and renders a page, the flash variable is available but if we render the same (or other) page again the flash variable is not present (it is destroyed).</p>\n</blockquote>\n<p>The approximate code for the previous flow is as follows. First, the next code is responsible to receive the post data and register the user:</p>\n<p>{% highlight javascript %}\n// process the signup form\nrouter.post('/signup', passport.authenticate('local-signup', {\nsuccessRedirect : '/profile', // redirect to the secure profile section\nfailureRedirect : '/signup', // redirect back to the signup page if there is an error\nfailureFlash : true // allow flash messages\n}));</pre></p>\n<p>The authentication is delegated to passport, which is implemented as:</p>\n<pre class=\"lang:js decode:true\">passport.use('local-signup', new LocalStrategy({\n    // by default, local strategy uses username and password, we will override with email\n    usernameField : 'email',\n    passwordField : 'password',\n    passReqToCallback : true // allows us to pass back the entire request to the callback\n},\nfunction(req, email, password, done) {\n    process.nextTick(function() {\n      // find a user whose email is the same as the forms email\n      // we are checking to see if the user trying to login already exists\n      User.findOne({ 'email' :  email }, function(err, user) {\n          // if there are any errors, return the error\n          if (err) {\n            return done(err);\n          }\n          // check to see if theres already a user with that email\n          if (user) {\n            return done(null, false, req.flash('signupMessage', 'That email is already taken.'));\n          } else {\n            // if there is no user with that email\n            // create the user\n            var user = new User();\n            user.local.email    = email;\n            user.local.password = user.generateHash(password);\n            user.save(function(err) {\n              if (err) {\n                throw err;\n              }\n              return done(null, user);\n            });\n          }\n      });\n    });\n}));\n{% endhighlight %}\n\nAs you can see, if the user exists we add a flash session message with: `req.flash('signupMessage', 'That email is already taken.'));`.\n\nOn the other side, we show the signup form each time user access to the `/signup` resource via GET method:\n\n{% highlight javascript %}\nrouter.get('/signup', function(req, res) {\n  res.render('signup',  { message: req.flash('signupMessage') });\n});\n{% endhighlight %}\n\nHere we are rendering the `signup` template passing a message with the value of the signupMessage message. This way if user is redirected to the form, because the signup process fails (that is, the access to the `/signup` resource via POST), then the error message is shown.\n\n### The mystery\n\nThe problem was I never get a value for the flash variable. What? Yes, I never get a value for the flash variable.\n\nThere was no error, I can't set and (in the same method) get the flash value, but I can't get value any value among different resources, that is, between GET `/signup` and POST `/signup`.\n\n### The solution\n\nAfter too much time (too many to be recognised publicly) I found my problem was with the way I initialise my sessions. What ? Yes, I said it was my fault due the way I initialise the session. This I did it:\n\n{% highlight javascript %}\napp.use(session({\n  secret: config.sessionSecret,\n  resave: false,\n  saveUninitialized: true,\n  cookie: { secure: true }\n}));\n{% endhighlight %}\n\nCan you see the problem? Here goes a clue, think I was working with a `dev` profile, that is, in my local machine accessing resources without HTTPS.\n\n_**Yes, the problem was to set the `secure: true`  and does not access resources via HTTPS.**_\n\nThe [express-session](https://github.com/expressjs/session) middleware documentation says (yes, go to the cookie section):\n\n> Please note that `secure: true` is a **recommended** option. However, it requires an https-enabled website, i.e., HTTPS is necessary for secure cookies. **If `secure` is set, and you access your site over HTTP, the cookie will not be set**. If you have your node.js behind a proxy and are using `secure: true`, you need to set \"trust proxy\" in express.\n\n### Conclusions\n\nI'm happy to found the problem. Right now, while I write this lines, I'm at a tattoo shop waiting to be tattooed with the previous beautiful sentence.\n","excerpt":"Recently I started an application using NodeJS with ExpressJS framework and decided to use passport for authenticate the users. As many other times I wanted to use flash messages so, when user authentication fails, the application shows a message informing about bad credentials. Nothing new on the horizon until.... OMG !!! I can't see the flash messages !!! Disclaimer: This is a really stupid history with me as starring. I like to learn from my errors and because of this I decide to write this post both as a punishment and to ensure I don't forget it again. The crime scene I was working implementing a sign up process, where the user writes its credentials and system creates as a new user or returns an error message like \"Sorry, but a username with that email exists\" or similar. Before introduce any code, the flow is as follows: User access the  page via GET method. Data is sent to  resource via POST method, which is responsible to: Check if data is fine, create a new user and redirected to the  page. If a user with the same email exists we redirect again to the  page (that is, using the GET method) with a flash message related to bad credentials. Note: A flash message is a variable stored within a session that is only available once, for the next request. That is if we put a flash variable and renders a page, the flash variable is available but if we render the same (or other) page again the flash variable is not present (it is destroyed). The approximate code for the previous flow is as follows. First, the next code is responsible to receive the post data and register the user: {% highlight javascript %}\n// process the signup form\nrouter.post('/signup', passport.authenticate('local-signup', {\n  successRedirect : '/profile', // redirect to the secure profile section\n  failureRedirect : '/signup', // redirect back to the signup page if there is an error\n  failureFlash : true // allow flash messages\n})); The authentication is delegated to passport, which is implemented as:","frontmatter":{"date":"30 March, 2015","title":"The mystery of no flash session variables in Express + Passport auth"},"fields":{"slug":"/blog/2015/03/30/the-mystery-of-no-flash-session-variables-in-express-passport-auth","readingTime":{"text":"5 min read"}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/2015/03/30/the-mystery-of-no-flash-session-variables-in-express-passport-auth"}}}